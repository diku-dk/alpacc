name: CI

on:
  push:

jobs:
  haskell-test:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v3

      - name: Set up GHC 9.2.7
        uses: haskell/actions/setup@v2
        id: setup
        with:
          ghc-version: '9.2.7'
          cabal-version: '3.10.1.0'
          cabal-update: true

      - name: Installed versions of GHC and Cabal
        shell: bash
        run: |
          GHC_VERSION=$(ghc --numeric-version)
          CABAL_VERSION=$(cabal --numeric-version)
          echo "GHC_VERSION=${GHC_VERSION}"     >> "${GITHUB_ENV}"
          echo "CABAL_VERSION=${CABAL_VERSION}" >> "${GITHUB_ENV}"
      
      - name: Install dependencies
        run: cabal build all --only-dependencies

      - name: Build
        run: cabal build all

      - name: Run tests
        run: cabal test all
  
  futhark-test:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v3

    - name: Install Nix
      uses: cachix/install-nix-action@v20
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - name: Run tests
      run:  |
        nix-shell shell.nix --pure --run "
        cabal update &&
        virtualenv venv &&
        source ./venv/bin/activate &&
        python -m pip install --upgrade pip &&
        python -m pip install -r futhark-parser-tests/requirements.txt &&
        python futhark-parser-tests"